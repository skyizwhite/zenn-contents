---
title: "ã€Common Lispã€‘defclassã®ã‚¹ãƒ­ãƒƒãƒˆã‚’å‹å®‰å…¨ã«ã™ã‚‹"
emoji: "â˜¯ï¸"
type: "tech"
topics:
  - "commonlisp"
published: true
published_at: "2023-07-27 11:25"
---

æ³¨ 1: æœ¬è¨˜äº‹ã¯ 2023 å¹´ 3 æœˆã«ç­†è€…ãŒå€‹äººã‚µã‚¤ãƒˆ([skyizwhite.dev](https://skyizwhite.dev) ç¾åœ¨ã¯é–‰é–)ã§å…¬é–‹ã—ãŸè¨˜äº‹ã¨åŒä¸€ã®å†…å®¹ã§ã™
æ³¨ 2: Common Lisp å‡¦ç†ç³»ã¯ SBCL 2.3.1 ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™

## defclass ã®å‹æ³¨é‡ˆã¯å‹å®‰å…¨ã‚’ä¿è¨¼ã—ãªã„

`defclass` ãƒã‚¯ãƒ­ã§ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹éš›ã€ã‚¹ãƒ­ãƒƒãƒˆã«å¯¾ã—ã¦ä¸‹è¨˜ã®ã‚ˆã†ã«å‹æ³¨é‡ˆã‚’ä»˜ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```lisp
(defclass person ()
  ((name :type     string
         :accessor person-name
         :initarg  :name)
   (age  :type     integer
         :accessor person-age
         :initarg  :age)))

(defun make-person (&key name age)
  (make-instance 'person
                 :name name
                 :age  age))
```

ãã‚Œã§ã¯ person ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†... ãŠã£ã¨æ‰‹ãŒæ»‘ã£ãŸ

```lisp
CL-USER> (make-person :name 20 :age "taro")
#<PERSON {701189FBE3}>
CL-USER> (person-name *)
20
```

å‹æ³¨é‡ˆã¨ç•°ãªã‚‹å‹ã®å€¤ãŒæ ¼ç´ã•ã‚Œã¾ã—ãŸãŒã€ã‚¨ãƒ©ãƒ¼ã¯ç™ºç”Ÿã—ã¦ã„ã¾ã›ã‚“ã€‚ä½•æ•…ã“ã†ãªã£ãŸã‹ã‚’èª¿ã¹ã¦ã¿ãŸã¨ã“ã‚ã€

> The :type slot option specifies that the contents of the slot will always be of the specified data type. It effectively declares the result type of the reader generic function when applied to an object of this class. The consequences of attempting to store in a slot a value that does not satisfy the type of the slot are undefined.

(å‡ºå…¸: [CLHS: Macro DEFCLASS - LispWorks](http://www.lispworks.com/documentation/HyperSpec/Body/m_defcla.htm))

ã¨ã®è¨˜è¿°ãŒã‚ã‚Šã€ç•°ãªã‚‹å‹ã‚’æŒã¤å€¤ãŒã‚¹ãƒ­ãƒƒãƒˆã«æ ¼ç´ã•ã‚ŒãŸæ™‚ã®çµæœã¯æœªå®šç¾©ã¨ã®ã“ã¨ã€‚ãã“ã§ã€ã“ã®æ“ä½œã®çµæœã¨ã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç«ã•ã›ã¦å‹å®‰å…¨ã«ã™ã‚‹æ–¹æ³•ã«ã¤ã„ã¦èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

## è§£æ±ºç­–ãã® 1ï¼šæœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ safety ã‚’åˆ©ç”¨ã™ã‚‹

SBCL ã®å‡¦ç†ç³»ä¾å­˜ã®æ©Ÿèƒ½ã§ã™ãŒã€ã‚¯ãƒ©ã‚¹å®šç¾©ã‚„ã‚¹ãƒ­ãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã†ç®‡æ‰€ã§`(declaim (optimize safety))`ã¨ã„ã†æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã™ã‚‹ã“ã¨ã§ã€å€¤ã®æ ¼ç´æ™‚ã«å‹åˆ¤å®šãŒèµ°ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## è§£æ±ºç­–ãã® 2ï¼šã‚¹ãƒ­ãƒƒãƒˆæ ¼ç´æ™‚ã«å‹åˆ¤å®šã‚’è¡Œã†ãƒ¡ã‚¿ã‚¯ãƒ©ã‚¹ã‚’å°å…¥ã™ã‚‹

æ¬¡ã«ç¤ºã™æ–¹æ³•ã¯[MOP(MetaObject Protocol)](https://franz.com/support/documentation/10.1/doc/mop/index.html)ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ã§ã™ã€‚MOP ã¯ ANSI Common Lisp ã®ä»•æ§˜ã«ã¯å«ã¾ã‚Œã¾ã›ã‚“ãŒã€æ§˜ã€…ãªå‡¦ç†ç³»ã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰ã®æ©Ÿèƒ½ã§ã™ã€‚å‡¦ç†ç³»ä¾å­˜ã®æ©Ÿèƒ½ãªã®ã§ã€å®Ÿè£…ã§ã¯ãã‚Œã‚‰ã®å·®ç•°ã‚’å¸åã—ãŸ[Closer to MOP](https://github.com/pcostanza/closer-mop)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’åˆ©ç”¨ã—ã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚ˆã†ã«ã€valid-class ã¨ã„ã†ãƒ¡ã‚¿ã‚¯ãƒ©ã‚¹ã¨ã€ã‚¹ãƒ­ãƒƒãƒˆæ ¼ç´æ™‚ã«å‹åˆ¤å®šã‚’è¡Œã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```lisp
(ql:quickload :closer-mop)

(defclass valid-class (c2mop:standard-class)
  ())

(defmethod c2mop:validate-superclass ((class valid-class)
                                      (superclass c2mop:standard-class))
  t)

(defmethod (setf c2mop:slot-value-using-class) :before (new-value
                                                        (class valid-class)
                                                        object
                                                        slot)
  (let ((slot-type (c2mop:slot-definition-type slot)))
    (unless (typep new-value slot-type)
      (error 'type-error :datum new-value :expected-type slot-type))))
```

`defclass`ãƒã‚¯ãƒ­å‘¼ã³å‡ºã—ã§å…ˆã»ã©ä½œæˆã—ãŸ`valid-class`ã‚’ãƒ¡ã‚¿ã‚¯ãƒ©ã‚¹ã¨ã—ã¦æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ã‚¹ãƒ­ãƒƒãƒˆæ ¼ç´æ™‚ã«å‹åˆ¤å®šãŒèµ°ã‚‹ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```lisp
(defclass person ()
  ((name :type     string
         :accessor person-name
         :initarg  :name)
   (age  :type     integer
         :accessor person-age
         :initarg  :age))
  (:metaclass valid-class))
```

ãã‚Œã§ã¯å®Ÿéš›ã« valid-class ã‚’ãƒ¡ã‚¿ã‚¯ãƒ©ã‚¹ã«æŒã¤ person ã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

```lisp
CL-USER> (make-person :name 20 :age "taro")
The value
  20
is not of type
  STRING
   [Condition of type TYPE-ERROR]

CL-USER> (make-person :name "taro" :age "20")
The value
  "20"
is not of type
  INTEGER
   [Condition of type TYPE-ERROR]

CL-USER> (make-person :name "taro" :age 20)
#<PERSON {7011D717F3}>

CL-USER> (setf (person-age *) "20")
The value
   "20"
is not of type
   INTEGER
    [Condition of type TYPE-ERROR]
```

ã‚¹ãƒ­ãƒƒãƒˆã®å‹åˆ¤å®šãŒè¡Œã‚ã‚Œã¦ã„ã¾ã™ã­ ğŸ‘Œ

## å‚è€ƒæ–‡çŒ®

- [CLHS: Macro DEFCLASS - LispWorks](http://www.lispworks.com/documentation/lw71/CLHS/Body/m_defcla.htm)
- [SBCL 2.3.2 User Manual](https://www.sbcl.org/manual/)
- [The Common Lisp Object System MetaObject Protocol](https://franz.com/support/documentation/10.1/doc/mop/index.html)
